<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pontos de Acesso &mdash; Captive Portal</title>
  <%- include('_head') %>
  <style>
    .summary-cards { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
    .summary-card {
      display: flex; align-items: center; gap: 12px;
      background: #fff; border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,.08);
      padding: 14px 20px; min-width: 140px;
    }
    .summary-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
    .dot-green  { background: #16a34a; }
    .dot-red    { background: #ef4444; }
    .dot-gray   { background: #9ca3af; }
    .dot-total  { background: #0d4e8b; }
    .summary-val { font-size: 1.6rem; font-weight: 700; line-height: 1; color: #1f2937; }
    .summary-lbl { font-size: .72rem; color: #6b7280; margin-top: 2px; }

    .toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }

    .btn-ping {
      padding: 8px 18px; background: #0d4e8b; color: #fff;
      border: none; border-radius: 8px; font-size: .875rem;
      cursor: pointer; display: flex; align-items: center; gap: 8px;
      transition: background .15s;
    }
    .btn-ping:hover { background: #0a3d6e; }
    .btn-ping:disabled { background: #93c5fd; cursor: not-allowed; }

    .spin { display: inline-block; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .last-check { font-size: .8rem; color: #6b7280; }

    .badge-online  { background: #dcfce7; color: #16a34a; }
    .badge-offline { background: #fee2e2; color: #ef4444; }
    .badge-unknown { background: #f3f4f6; color: #9ca3af; }

    .latency { font-size: .8rem; color: #6b7280; }
    .latency.fast  { color: #16a34a; }
    .latency.slow  { color: #d97706; }
    .latency.very-slow { color: #ef4444; }

    .btn-del {
      padding: 4px 10px; background: none; border: 1px solid #ef4444;
      color: #ef4444; border-radius: 6px; font-size: .78rem; cursor: pointer;
    }
    .btn-del:hover { background: #ef4444; color: #fff; }

    .btn-hist {
      padding: 4px 10px; background: none; border: 1px solid #0d4e8b;
      color: #0d4e8b; border-radius: 6px; font-size: .78rem; cursor: pointer;
    }
    .btn-hist:hover { background: #0d4e8b; color: #fff; }

    /* Modal de histórico */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: #fff; border-radius: 12px;
      box-shadow: 0 4px 32px rgba(0,0,0,.2);
      width: 90%; max-width: 640px; max-height: 80vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-header {
      padding: 18px 22px; border-bottom: 1px solid #e5e7eb;
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h3 { font-size: 1rem; font-weight: 700; color: #0d4e8b; }
    .modal-close {
      background: none; border: none; font-size: 1.4rem;
      cursor: pointer; color: #6b7280; line-height: 1;
    }
    .modal-body { padding: 16px 22px; overflow-y: auto; flex: 1; }
    .hist-table { width: 100%; border-collapse: collapse; font-size: .82rem; }
    .hist-table th { text-align: left; padding: 7px 10px; background: #f9fafb; color: #6b7280; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
    .hist-table td { padding: 7px 10px; border-bottom: 1px solid #f3f4f6; }
    .hist-loading { text-align: center; color: #6b7280; padding: 24px; }
    .hist-empty { text-align: center; color: #9ca3af; padding: 24px; }

    /* Formulário de adição */
    .add-card {
      background: #fff; border-radius: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,.08);
      padding: 24px; max-width: 680px; margin-top: 28px;
    }
    .add-card h3 { font-size: 1rem; font-weight: 700; color: #0d4e8b; margin-bottom: 18px; }
    .add-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .add-field { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 140px; }
    .add-field label { font-size: .8rem; font-weight: 600; color: #374151; }
    .add-field input {
      padding: 8px 10px; border: 1px solid #d1d5db;
      border-radius: 7px; font-size: .875rem; color: #1f2937;
    }
    .add-field input:focus { outline: none; border-color: #0d4e8b; box-shadow: 0 0 0 3px rgba(13,78,139,.1); }
    .btn-add {
      margin-top: 18px; padding: 9px 24px;
      background: #16a34a; color: #fff;
      border: none; border-radius: 8px;
      font-size: .875rem; font-weight: 600; cursor: pointer;
    }
    .btn-add:hover { background: #15803d; }

    .alert { padding: 10px 16px; border-radius: 8px; font-size: .875rem; margin-bottom: 16px; max-width: 680px; }
    .alert-success { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
    .alert-error   { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

    .empty-row td { text-align: center; color: #9ca3af; padding: 32px !important; }
  </style>
</head>
<body>
  <%- include('_nav', { page: pageObj }) %>

  <main class="container">
    <h2 class="page-title">Pontos de Acesso</h2>

    <% if (success) { %>
      <div class="alert alert-success"><%= success %></div>
    <% } %>
    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <!-- Cards de resumo -->
    <div class="summary-cards">
      <div class="summary-card">
        <span class="summary-dot dot-total"></span>
        <div>
          <div class="summary-val"><%= aps.length %></div>
          <div class="summary-lbl">Total</div>
        </div>
      </div>
      <div class="summary-card">
        <span class="summary-dot dot-green"></span>
        <div>
          <div class="summary-val" id="count-online"><%= online %></div>
          <div class="summary-lbl">Online</div>
        </div>
      </div>
      <div class="summary-card">
        <span class="summary-dot dot-red"></span>
        <div>
          <div class="summary-val" id="count-offline"><%= offline %></div>
          <div class="summary-lbl">Offline</div>
        </div>
      </div>
      <div class="summary-card">
        <span class="summary-dot dot-gray"></span>
        <div>
          <div class="summary-val" id="count-unknown"><%= unknown %></div>
          <div class="summary-lbl">Não verificado</div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn-ping" id="btn-ping" onclick="pingNow()" data-csrf="<%= locals.csrfToken || '' %>">
        <span id="ping-icon">&#9654;</span>
        <span id="ping-label">Verificar Agora</span>
      </button>
      <span class="last-check" id="last-check-text">
        <% if (aps.length > 0 && aps[0].last_checked_at !== 'Nunca') { %>
          Última verificação automática: próximo ciclo em 5 min
        <% } %>
      </span>
    </div>

    <!-- Tabela de APs -->
    <div class="table-wrap">
      <table id="ap-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Localização</th>
            <th>IP</th>
            <th>Status</th>
            <th>Latência</th>
            <th>Última verificação</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody id="ap-tbody">
          <% if (aps.length === 0) { %>
            <tr class="empty-row"><td colspan="7">Nenhum ponto de acesso cadastrado.<br>Adicione abaixo.</td></tr>
          <% } %>
          <% aps.forEach(ap => { %>
            <tr id="row-<%= ap.id %>">
              <td><strong><%= ap.name %></strong></td>
              <td><%= ap.location %></td>
              <td><code><%= ap.ip_address %></code></td>
              <td>
                <% if (ap.is_online === true) { %>
                  <span class="badge badge-online" id="status-<%= ap.id %>">Online</span>
                <% } else if (ap.is_online === false) { %>
                  <span class="badge badge-offline" id="status-<%= ap.id %>">Offline</span>
                <% } else { %>
                  <span class="badge badge-unknown" id="status-<%= ap.id %>">Não verificado</span>
                <% } %>
              </td>
              <td>
                <% if (ap.latency_ms !== null) { %>
                  <% const cls = ap.latency_ms < 10 ? 'fast' : ap.latency_ms < 50 ? 'slow' : 'very-slow'; %>
                  <span class="latency <%= cls %>" id="latency-<%= ap.id %>"><%= ap.latency_ms %> ms</span>
                <% } else { %>
                  <span class="latency" id="latency-<%= ap.id %>">—</span>
                <% } %>
              </td>
              <td id="checked-<%= ap.id %>"><%= ap.last_checked_at %></td>
              <td style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
                <button type="button" class="btn-hist" data-id="<%= ap.id %>" data-name="<%= ap.name %>">Histórico</button>
                <form method="POST" action="/admin/access-points/<%= ap.id %>/delete"
                      onsubmit="return confirm('Remover ' + <%- JSON.stringify(ap.name) %> + ' do monitoramento?')">
                  <input type="hidden" name="_csrf" value="<%= locals.csrfToken || '' %>">
                  <button type="submit" class="btn-del">Remover</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Formulário de adição -->
    <div class="add-card">
      <h3>Adicionar Ponto de Acesso</h3>
      <form method="POST" action="/admin/access-points" id="form-add-ap">
        <input type="hidden" name="_csrf" value="<%= locals.csrfToken || '' %>">
        <div class="add-row">
          <div class="add-field">
            <label for="ap-name">Nome *</label>
            <input type="text" id="ap-name" name="name" required maxlength="100"
                   placeholder="AP Recepção, AP UTI...">
          </div>
          <div class="add-field">
            <label for="ap-ip">Endereço IP *</label>
            <input type="text" id="ap-ip" name="ip_address" required maxlength="45"
                   placeholder="192.168.1.1">
          </div>
          <div class="add-field">
            <label for="ap-location">Localização</label>
            <input type="text" id="ap-location" name="location" maxlength="200"
                   placeholder="Piso 1 - Ala Norte">
          </div>
        </div>
        <button type="submit" class="btn-add">Adicionar</button>
      </form>
    </div>
  </main>

  <%- include('_footer') %>

  <!-- Modal de histórico de latência (antes do script para que getElementById funcione) -->
  <div class="modal-overlay hidden" id="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Histórico</h3>
        <button class="modal-close" onclick="closeModal()">&#215;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script>
    // Formata data ISO para pt-BR
    function fmtDate(iso) {
      if (!iso) return '—';
      return new Date(iso).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
    }

    // Verifica agora via AJAX
    async function pingNow() {
      const btn = document.getElementById('btn-ping');
      const icon = document.getElementById('ping-icon');
      const label = document.getElementById('ping-label');

      btn.disabled = true;
      icon.textContent = '↻';
      icon.classList.add('spin');
      label.textContent = 'Verificando...';

      try {
        const csrf = btn.dataset.csrf || '';
        const res = await fetch('/admin/access-points/ping', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf }
        });
        const data = await res.json();

        if (data.ok && data.results) {
          let online = 0, offline = 0, unknown = 0;

          data.results.forEach(ap => {
            // Atualiza badge de status
            const statusEl = document.getElementById('status-' + ap.id);
            if (statusEl) {
              statusEl.className = 'badge ' + (ap.online ? 'badge-online' : 'badge-offline');
              statusEl.textContent = ap.online ? 'Online' : 'Offline';
            }

            // Atualiza latência
            const latEl = document.getElementById('latency-' + ap.id);
            if (latEl) {
              if (ap.latency_ms !== null) {
                const cls = ap.latency_ms < 10 ? 'fast' : ap.latency_ms < 50 ? 'slow' : 'very-slow';
                latEl.className = 'latency ' + cls;
                latEl.textContent = ap.latency_ms + ' ms';
              } else {
                latEl.className = 'latency';
                latEl.textContent = '—';
              }
            }

            // Atualiza última verificação
            const chkEl = document.getElementById('checked-' + ap.id);
            if (chkEl) chkEl.textContent = fmtDate(data.checked_at);

            if (ap.online) online++; else offline++;
          });

          // Atualiza cards de resumo
          const total = data.results.length;
          unknown = total - online - offline;
          const elOnline = document.getElementById('count-online');
          const elOffline = document.getElementById('count-offline');
          const elUnknown = document.getElementById('count-unknown');
          if (elOnline) elOnline.textContent = online;
          if (elOffline) elOffline.textContent = offline;
          if (elUnknown) elUnknown.textContent = Math.max(0, unknown);

          document.getElementById('last-check-text').textContent =
            'Verificado em: ' + fmtDate(data.checked_at);
        }
      } catch (e) {
        alert('Erro ao verificar pontos de acesso. Tente novamente.');
      } finally {
        btn.disabled = false;
        icon.textContent = '▶';
        icon.classList.remove('spin');
        label.textContent = 'Verificar Agora';
      }
    }

    // Validação de IP no formulário
    document.getElementById('form-add-ap').addEventListener('submit', function(e) {
      const ip = document.getElementById('ap-ip').value.trim();
      const ipRe = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;
      const m = ipRe.exec(ip);
      if (!m || !m.slice(1).every(n => parseInt(n, 10) <= 255)) {
        e.preventDefault();
        alert('Endereço IP inválido. Use o formato 192.168.1.1');
        document.getElementById('ap-ip').focus();
      }
    });

    // Auto-refresh a cada 5 minutos (coincide com o cron do servidor)
    setTimeout(() => location.reload(), 5 * 60 * 1000);

    // ─── Modal de histórico de latência ───────────────────────────────────────
    async function showHistory(apId, apName) {
      const overlay = document.getElementById('modal-overlay');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      title.textContent = 'Histórico: ' + apName;
      body.innerHTML = '<div class="hist-loading">Carregando...</div>';
      overlay.classList.remove('hidden');

      try {
        const res = await fetch('/admin/access-points/' + apId + '/history');
        const data = await res.json();

        if (!data.history || data.history.length === 0) {
          body.innerHTML = '<div class="hist-empty">Nenhum dado de histórico ainda.</div>';
          return;
        }

        const rows = data.history.map(h => {
          const statusCls = h.is_online ? 'badge-online' : 'badge-offline';
          const statusTxt = h.is_online ? 'Online' : 'Offline';
          const lat = h.latency_ms !== null ? h.latency_ms + ' ms' : '—';
          const cls = h.latency_ms === null ? '' : h.latency_ms < 10 ? 'fast' : h.latency_ms < 50 ? 'slow' : 'very-slow';
          return `<tr>
            <td>${fmtDate(h.checked_at)}</td>
            <td><span class="badge ${statusCls}">${statusTxt}</span></td>
            <td><span class="latency ${cls}">${lat}</span></td>
          </tr>`;
        }).join('');

        body.innerHTML = `
          <table class="hist-table">
            <thead><tr><th>Data/Hora</th><th>Status</th><th>Latência</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
      } catch (e) {
        body.innerHTML = '<div class="hist-empty">Erro ao carregar histórico.</div>';
      }
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
    }

    // Botões de histórico: usa data attributes para evitar problemas de escape HTML no onclick
    document.querySelectorAll('.btn-hist').forEach(function(btn) {
      btn.addEventListener('click', function() {
        showHistory(this.dataset.id, this.dataset.name);
      });
    });

    // Fechar modal clicando fora
    document.getElementById('modal-overlay').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
  </script>
</body>
</html>
